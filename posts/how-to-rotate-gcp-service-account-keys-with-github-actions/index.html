<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="How to Rotate GCP Service Account Keys with GitHub Actions"><meta name=keywords content="kubernetes,cloud,machinelearning,github"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://afritzler.github.io/posts/how-to-rotate-gcp-service-account-keys-with-github-actions/><script type=text/javascript>var cpm={};(function(e,t,n){var o=e.getElementsByTagName("script")[0],s=e.createElement("script");s.async=!0,s.src="https://cookiehub.net/c2/0f57d976.js",s.onload=function(){t.cookiehub.load(n)},o.parentNode.insertBefore(s,o)})(document,window,cpm)</script><title>How to Rotate GCP Service Account Keys with GitHub Actions :: Andreas Fritzler — My personal website</title><link rel=stylesheet href=/main.b78c3be9451dc4ca61ca377f3dc2cf2e6345a44c2bae46216a322ef366daa399.css integrity="sha256-t4w76UUdxMphyjd/PcLPLmNFpEwrrkYhajIu82bao5k="><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><meta name=msapplication-TileColor content><meta itemprop=name content="How to Rotate GCP Service Account Keys with GitHub Actions"><meta itemprop=description content="How to Rotate GCP Service Account Keys with GitHub Actions"><meta itemprop=datePublished content="2023-04-28T00:00:00+00:00"><meta itemprop=dateModified content="2023-04-28T00:00:00+00:00"><meta itemprop=wordCount content="464"><meta itemprop=image content="https://afritzler.github.io"><meta itemprop=keywords content="github,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://afritzler.github.io"><meta name=twitter:title content="How to Rotate GCP Service Account Keys with GitHub Actions"><meta name=twitter:description content="How to Rotate GCP Service Account Keys with GitHub Actions"><meta property="article:section" content="github"><meta property="article:published_time" content="2023-04-28 00:00:00 +0000 UTC"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>AF</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/posts>Blog</a></li><li><a href=/projects/>Projects</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>3 minutes</p></div><article><h1 class=post-title><a href=https://afritzler.github.io/posts/how-to-rotate-gcp-service-account-keys-with-github-actions/>How to Rotate GCP Service Account Keys with GitHub Actions</a></h1><div class=post-excerpt>How to Rotate GCP Service Account Keys with GitHub Actions</div><div class=post-content><p>In this blog post, we&rsquo;ll cover how to automate the rotation of Google Cloud Platform (GCP) service account keys using
GitHub Actions. Regularly rotating service account keys is a security best practice to help mitigate the risk of
unauthorized access.</p><h2 id=prerequisites>Prerequisites</h2><p>Before we start, ensure that you have the following set up:</p><ol><li>A GCP project with a service account and key.</li><li>A GitHub account and a GitHub repository.</li><li>The <a href=https://cloud.google.com/sdk>Google Cloud SDK (gcloud)</a> installed and configured.</li><li>The <a href=https://cli.github.com/>GitHub CLI (gh)</a> installed and authenticated.</li></ol><h2 id=rotating-gcp-service-account-keys-using-github-actions>Rotating GCP Service Account Keys using GitHub Actions</h2><p>Here are the steps to set up a GitHub Action for rotating GCP service account keys:</p><h3 id=1-create-github-secrets>1. Create GitHub Secrets</h3><p>Create the following secrets in your GitHub repository (Settings > Secrets > New repository secret):</p><ul><li><code>GCP_PROJECT_ID</code>: Your GCP project ID</li><li><code>GCP_SA_KEY</code>: Your GCP service account JSON key file, encoded in base64 (use <code>base64 &lt;key-file>.json</code> to get the encoded content)</li></ul><h3 id=2-create-the-github-workflow>2. Create the GitHub Workflow</h3><p>Create a new file in your repository: <code>.github/workflows/rotate-gcp-service-account-key.yml</code> and add the following content:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>name</span>: <span style=color:#ae81ff>Rotate GCP Service Account Key</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>on</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>workflow_dispatch</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>jobs</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>rotate-key</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>runs-on</span>: <span style=color:#ae81ff>ubuntu-latest</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Checkout repository</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/checkout@v2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Set up Google Cloud SDK</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>google-github-actions/setup-gcloud@v0.2.1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>project_id</span>: <span style=color:#ae81ff>${{ secrets.GCP_PROJECT_ID }}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>service_account_key</span>: <span style=color:#ae81ff>${{ secrets.GCP_SA_KEY }}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>export_default_credentials</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Rotate Service Account Key</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>run</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        SERVICE_ACCOUNT_NAME=&#34;your-service-account-name&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        KEY_FILE=&#34;new-service-account-key.json&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        PROJECT_ID=&#34;${{ secrets.GCP_PROJECT_ID }}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        SERVICE_ACCOUNT_EMAIL=&#34;$SERVICE_ACCOUNT_NAME@$PROJECT_ID.iam.gserviceaccount.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        # Create a new service account key
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        gcloud iam service-accounts keys create $KEY_FILE --iam-account $SERVICE_ACCOUNT_EMAIL
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        # Encode the new key file in base64
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        ENCODED_KEY=$(base64 $KEY_FILE)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        # Update the GitHub secret with the new key
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        echo $ENCODED_KEY | gh secret set GCP_SA_KEY --repo $GITHUB_REPOSITORY --body -
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        # Get the existing keys and remove the oldest key
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        OLD_KEY_ID=$(gcloud iam service-accounts keys list --iam-account $SERVICE_ACCOUNT_EMAIL --format=&#34;get(name.basename())&#34; --sort-by=&#34;~validAfterTime&#34; --limit=1)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        if [ ! -z &#34;$OLD_KEY_ID&#34; ]; then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          gcloud iam service-accounts keys delete $OLD_KEY_ID --iam-account $SERVICE_ACCOUNT_EMAIL --quiet
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        fi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        # Clean up the generated key file
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        rm $KEY_FILE</span>        
</span></span></code></pre></div><p>Replace <code>your-service-account-name</code> with the name of the service account you want to rotate the key for.</p><h3 id=3-run-the-workflow>3. Run the Workflow</h3><p>You can now manually trigger the rotation of the GCP service account key by navigating to the &ldquo;Actions&rdquo; tab in your
repository, selecting the &ldquo;Rotate GCP Service Account Key&rdquo; workflow, and clicking on &ldquo;Run workflow.&rdquo;</p><h3 id=conclusion>Conclusion</h3><p>In this blog post, we&rsquo;ve shown you how to set up a GitHub Actions workflow to rotate GCP service account keys
automatically. By following these steps, you can improve the security of your GCP projects and ensure that your
service account keys are regularly rotated according to best practices.</p><p>GitHub Actions provides a powerful and flexible platform for automating various tasks, including managing cloud
infrastructure, building and deploying applications, and automating security practices. With the integration of GCP
and GitHub Actions, you can create seamless workflows to manage and maintain your cloud resources effectively.</p><p>Happy automating!</p></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://afritzler.github.io/tags/github/>github</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg><span class=tag><a href=https://afritzler.github.io/categories/github/>github</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>464 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2023-04-28 00:00 +0000</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=https://afritzler.github.io/posts/4-weeks-with-the-keychron-k6-mechanical-keyboard/><span class=button__text>4 Weeks with the Keychron K6 Mechanical Keyboard</span>
<span class=button__icon>→</span></a></span></div></div><div id=comments><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//afritzler-github-io.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.205d491810c28f95aa953fae884e1c27abe13fdf93ec63b882d0036b248d4a6282eb2d134e4e7225c6ad6e86db87b08488a361ca4a7383d01fcff43f3d57b9c3.js integrity="sha512-IF1JGBDCj5WqlT+uiE4cJ6vhP9+T7GO4gtADaySNSmKC6y0TTk5yJcatbobbh7CEiKNhykpzg9Afz/Q/PVe5ww=="></script></body></html>